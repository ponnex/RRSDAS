<link rel="import" href="/bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="na-rainflow">
  <template>
  <style is="custom-style" include="paper-date-picker-dialog-style">
    :host {
      --calculated-paper-toolbar-height: var(--paper-toolbar-height, 48px);
      --calculated-paper-toolbar-sm-height: var(--paper-toolbar-sm-height, 40px);

      position: absolute;
      top: var(--calculated-paper-toolbar-height);
      left: 0;
      right: 0;
      bottom: 0;
      color: #FFFFFF;

      height: auto;
      width: auto;
      margin: 0 2% 2% 2%;

      @apply(--layout-vertical);
    }
    .container {
      @apply(--layout-horizontal);
      height: 100%;
      margin-top: 2%;
    }
    .pickercontainer {
      @apply(--layout-horizontal);
    }

    .dropdown-content {
      @apply(--layout-vertical);
      width: fill;
      height: fill;
      padding: 0;
    }

    .graph-div {
      height: auto;
      width: 68%;
      padding-right: 2%;
    }

    .modules-summary-div {
      height: auto;
      width: 30%;
    }

    paper-item {
      padding: 8px;
    }

    paper-button.csv {
      --paper-button-ink-color: #515C6B;
      background-color: var(--paper-green-500);
      align-self: center;
    }

    download-csv {
      --iron-icon-fill-color: #FFFFFF;
    }

    iron-icon {
      --iron-icon-fill-color: #515C6B;
    }

    paper-date-picker {
      --default-primary-color: #515C6B;
      margin: 0;
    }

    paper-input {
      --paper-input-container-focus-color: #515C6B;
      padding-left: 2%;
    }

    google-chart {
      height: 100%;
      width: 100%;
    }

    @media (max-height: 600px) {
  		:host {
  			 top: var(--calculated-paper-toolbar-sm-height);
  		}
  	}
  </style>

  <paper-dialog id="rainStartDialog" style="margin: 15px 15px 15px 15px" class="paper-date-picker-dialog" with-backdrop
    on-iron-overlay-closed="rainStartDialogClosed">
    <paper-date-picker id="startPicker" date="{{startDate}}"></paper-date-picker>
    <!--<div class="buttons">
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button dialog-confirm>OK</paper-button>
    </div>-->
  </paper-dialog>

  <paper-dialog id="rainEndDialog" style="margin: 15px 15px 15px 15px" class="paper-date-picker-dialog" with-backdrop
    on-iron-overlay-closed="rainEndDialogClosed">
    <paper-date-picker id="endPicker" date="{{endDate}}" responsive-width="600px"></paper-date-picker>
    <!--<div class="buttons">
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button dialog-confirm>OK</paper-button>
    </div>-->
  </paper-dialog>

  <div id="pickercontainer" class="pickercontainer">

    <paper-dropdown-menu label="Sort By" vertical-align="top" horizontal-align="right">
      <paper-listbox class="dropdown-content" selected="0">
        <paper-item>Monthly</paper-item>
        <paper-item>Weekly</paper-item>
        <paper-item>Daily</paper-item>
      </paper-listbox>
    </paper-dropdown-menu>

    <paper-input id="startInput" onclick="rainStartDialog.open()" value="[[dateFormat(startDate, 'LL')]]" label="Start" name="[[name]]">
    <!--<paper-input id="startInput" onclick="dateDialog.open()" value="[[dateFormat(date, 'LL')]]" label="Start" name="[[name]]">-->
      <iron-icon icon="icons:event" item-icon prefix>
      </iron-icon>
      <iron-icon icon="icons:arrow-drop-down" item-icon suffix>
      </iron-icon>
    </paper-input>

    <paper-input id="endInput" onclick="rainEndDialog.open()" value="[[dateFormat(endDate, 'LL')]]" label="End" name="[[name]]">
      <iron-icon icon="icons:event" item-icon prefix>
      </iron-icon>
      <iron-icon icon="icons:arrow-drop-down" item-icon suffix>
      </iron-icon>
    </paper-input>

    <paper-button on-tap="test" raised class="csv"><iron-icon icon="file-download" class="download-csv"></iron-icon>Import CSV</paper-button>

  </div>

  <div id="container" class="container">
    <div class="graph-div">
      <google-chart
        id="rainflow"
        type='line'
        options='{"title": "Rain Flow"}'
        cols='[{"label":"Day", "type":"string"}, {"label":"Average", "type":"number"}]'
        rows='[["Monday", 32],["Tuesday", 52],["Wednesday", 82]]'>
      </google-chart>
    </div>
    <div class="modules-summary-div">
      <google-chart
        id="chartline2"
        type='line'
        options='{"title": "Rain Flow"}'
        cols='[{"label":"Hour", "type":"number"}, {"label":"M1", "type":"number"}, {"label":"M2", "type":"number"}]'
        rows='[[11, 31, 35],[12, 28, 24],[1, 31, 30]]'>
      </google-chart>
    </div>
  </div>

  </template>
  <script>
  Polymer({
    is: 'na-rainflow',
    behaviors: [
      Polymer.IronResizableBehavior
    ],properties: {
      isFirstTime: {
        type: Boolean,
        value: true
      },
      csvData: {
        type: String,
        value: ''
      }
    },
    listeners: {
      'iron-resize': '_onIronResize',
      'google-chart-ready': '_onChartReady'
    },
    ready: function() {
      this.$.startInput.value = moment(moment().subtract(1, 'month').calendar()).format('LL');
    },
    test: function() {
      document.querySelector('na-rainflow').downloadCsv("testcsv.csv", document.querySelector('na-rainflow').csvData)
    },
    attached: function() {
      this.async(this.notifyResize, 1);
    },
    _onIronResize: function() {
      this.$.rainflow.redraw();
      this.$.chartline2.redraw();
    },
    dateFormat: function(date, format) {

      if (this.isFirstTime) {
        var prevMM = moment(moment().subtract(1, 'month').calendar());
        var start = moment(prevMM).format('YYYY') + moment(prevMM).format('MM') + moment(prevMM).format('DD') + "00";
        var end = moment(this.endDate).format('YYYY') + moment(this.endDate).format('MM') + moment(this.endDate).format('DD') + "23";
        this.isFirstTime = false;
      } else {
        var start = moment(this.startDate).format('YYYY') + moment(this.startDate).format('MM') + moment(this.startDate).format('DD') + "00";
        var end = moment(this.endDate).format('YYYY') + moment(this.endDate).format('MM') + moment(this.endDate).format('DD') + "23";
      }

      var app = document.getElementById("firebaseApp").app;
      var database = firebase.database(app);

      var rain = [];
      var rainCounter = 0;
      var addition = 0;

      database.ref('/Modules/Data/').orderByKey().startAt(start).endAt(end).on('child_added', function(snapshot) {
        var day = moment(snapshot.key).format('dddd');

        snapshot.forEach(function(childSnapshot) {
          addition = childSnapshot.child('strmflow').val();
          var data = [day, addition];
          if (rainCounter == 0) {
            csv = moment(snapshot.key).format('MMMM Do YYYY') + ',' + '\r\n' + "Day,Time, Rainflow\r\n";
          }
          csv += moment(snapshot.key).format('dddd, h:mm:ss a') + ',' + addition + '\r\n';
          document.querySelector('na-rainflow').csvData = csv;

          rain[rainCounter] = data;
          rainCounter++;
        });
        document.getElementById("rainflow").rows = rain;
      });
      rainCounter = 0;

      this.$.rainStartDialog.close();
      this.$.rainEndDialog.close();

      return moment(date).format(format);
    },

    downloadCsv: function(filename, text) {
        var pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(text));
        pom.setAttribute('download', filename);

        if (document.createEvent) {
            var event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    },

    _onChartReady: function() {

    },

    rainStartDialogClosed: function() {

    },
    rainEndDialogClosed: function() {

    }
  });
  </script>
</dom-module>
